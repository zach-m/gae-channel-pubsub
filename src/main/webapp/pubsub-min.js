(function(){function i(e){var t=new goog.appengine.Channel(e);t.open({onopen:function(){a("*** onopen ***");n=true;r.listener.onConnect()},onmessage:function(e){a("*** onmessage: "+JSON.stringify(e));data=JSON.parse(e.data);r.listener.onMessageReceived(data.msg,data.topic)},onerror:function(e){a("*** onerror: "+JSON.stringify(e));r.listener.onError(e.code,e.description)},onclose:function(){a("*** onclose ***");n=false;r.listener.onDisconnect()}})}function s(e,t,n){var r=u("GET",e,t,n);r.send()}function o(e,t,n,r){var i=u("POST",e,n,r);i.setRequestHeader("Content-type","text/plain; charset=utf-8");i.send(t)}function u(e,t,n,r){var i;try{i=new XMLHttpRequest}catch(s){i=new ActiveXObject("MSXML2.XMLHTTP.3.0")}i.open(e,t,true);i.onreadystatechange=function(){if(i.readyState==4){if(i.status==200){var e=i.getResponseHeader("content-type");if(e&&e.indexOf("application/json")>=0)n(JSON.parse(i.responseText));else n(i.responseText)}else r(i.status,i.responseText)}};return i}function a(e){if(r.config.verbose)console.log(e)}var e=null;var t=null;var n=false;var r={config:{verbose:true},listener:{onConnect:function(){},onDisconnect:function(){},onMessageReceived:function(e,t){},onMessageSent:function(e,t){},onError:function(e,t){},onToken:function(e){},onSubscribe:function(e,t){}},connect:function(n){e=n;s(e,function(e){t=e.trim();a("*** ontoken: "+t);r.listener.onToken(t);i(t)})},subscribe:function(n){s(e+"/subscribe/"+n+"/"+t,function(e){subCount=e.subCount;a("*** onsubscribe: "+n+"  ("+subCount+" subscribers)");r.listener.onSubscribe(n,subCount)})},publish:function(n,i,s){var u=s&&s==true?"?exclude="+t:"";o(e+"/"+n+u,i,function(e){a("*** onpublish ("+n+"): "+i);r.listener.onMessageSent(i,e.subCount)})}};window.PBSB=r})()